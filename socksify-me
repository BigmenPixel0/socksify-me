#!/bin/bash
command="${1}"
version="0.2"
shift

while getopts ":p:4:" o; do
  case "${o}" in
    4)
      server_ipv4="${OPTARG}"
      ;;

    p)
      socks5_port="${OPTARG}"
      ;;

    *)
      exit 1
      ;;
  esac
done

# TODO: Add IPv6 here
default_gateway_ipv4=$(ip -4 route show table main | awk '$1=="default" {print $3}' | grep 192)

tun_device="tun0"
tun_ipv4="10.0.0.1"
tun_ipv6="fdfe:dcba:9876::1"
badvpn_ipv4="10.0.0.2"
badvpn_ipv6="fdfe:dcba:9876::2"

case "${command}" in
  start)
    killall badvpn-tun2socks
    ip -4 route del "${server_ipv4}" via "${default_gateway_ipv4}" metric 5
    ip tuntap del mode tun "${tun_device}"

    ip tuntap add mode tun "${tun_device}"
    ip -4 addr replace "${tun_ipv4}/24" dev "${tun_device}"
    ip -6 addr replace "${tun_ipv6}/126" dev "${tun_device}"
    ip link set "${tun_device}" up

    {
      badvpn-tun2socks --tundev "${tun_device}" --netif-ipaddr "${badvpn_ipv4}" --netif-ip6addr "${badvpn_ipv6}" --netif-netmask 255.255.255.0 --socks-server-addr "localhost:${socks5_port}" &
    } > /dev/null

    ip -4 route add "${server_ipv4}" via "${default_gateway_ipv4}" metric 5
    ip -4 route add default via "${badvpn_ipv4}" metric 6
    ip -6 route add default via "${badvpn_ipv6}" metric 6
    ;;

  stop)
    killall badvpn-tun2socks
    ip -4 route del "${server_ipv4}" via "${default_gateway_ipv4}" metric 5
    ip tuntap del mode tun "${tun_device}"
    ;;

  *)
    exit 1
    ;;
esac


